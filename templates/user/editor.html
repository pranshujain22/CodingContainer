<!DOCTYPE html>
{% extends 'user/home_base.html' %}

{% load staticfiles %}

{% block head %}
    <title>Editor</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="{% static 'codemirror/lib/codemirror.css' %}">
    <script src="{% static 'codemirror/lib/codemirror.js' %}"></script>
    <script src="{% static 'codemirror/mode/javascript/javascript.js' %}"></script>
    <script src="{% static 'codemirror/mode/xml/xml.js' %}"></script>
    <script src="{% static 'codemirror/addon/edit/closetag.js' %}"></script>
    <script src="{% static 'codemirror/addon/fold/xml-fold.js' %}"></script>
    <script src="{% static 'codemirror/addon/hint/xml-hint.js' %}"></script>
    <script src="{% static 'codemirror/addon/hint/html-hint.js' %}"></script>
    <script src="{% static 'codemirror/addon/hint/show-hint.js' %}"></script>
    <link rel="stylesheet" href="{% static 'codemirror/addon/hint/show-hint.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'codemirror/theme/dracula.css' %}">

<style>
    .lds-ring {
        display: inline-block;
        position: relative;
        width: 1.5em;
        height: 1.5em;
    }

    .lds-ring div {
        box-sizing: border-box;
        display: block;
        position: absolute;
        width: 1.3em;
        height: 1.3em;
        margin: .1em;
        border: .2em solid dodgerblue;
        border-radius: 50%;
        animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        border-color: dodgerblue transparent transparent transparent;
    }

    .lds-ring div:nth-child(1) {
        animation-delay: -0.45s;
    }

    .lds-ring div:nth-child(2) {
        animation-delay: -0.3s;
    }

    .lds-ring div:nth-child(3) {
        animation-delay: -0.15s;
    }

    @keyframes lds-ring {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .card .table td, .card .table th {
        padding-right: 0rem;
        padding-left: 0rem;
    }

    a:hover {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block page_name %}Files{% endblock %}

{% block body %}


    <!-- Sidenav -->
    <!-- Sidenav -->
    <nav class="navbar navbar-vertical fixed-left navbar-expand-md navbar-light bg-white" id="sidenav-main">
        <div class="container-fluid">
            <!-- Toggler -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#sidenav-collapse-main"
                    aria-controls="sidenav-main" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <!-- Brand -->
            <a class="navbar-brand pt-0" style="font-size: 1.25rem" href="{% url 'user:index' %}">
                <img src="{% static 'dashboard/assets/img/brand/favicon.png' %}">
                <span class="btn-inner--text text-blue">Coding Container</span>
            </a>
            <!-- User -->
            <ul class="nav align-items-center d-md-none">
                <li class="nav-item dropdown">
                    <a class="nav-link nav-link-icon" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                       aria-expanded="false">
                        <i class="ni ni-bell-55"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right"
                         aria-labelledby="navbar-default_dropdown_1">
                        <a class="dropdown-item" href="#">Action</a>
                        <a class="dropdown-item" href="#">Another action</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Something else here</a>
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link pr-0" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                       aria-expanded="false">
                        <div class="media align-items-center">
                            <span class="ni ni-single-02"></span>
                            <div class="media-body ml-2 d-none d-lg-block">
                                <span class="mb-0 text-sm  font-weight-bold">{{ request.session.enrollment_id }}</span>
                            </div>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right">
                        <div class=" dropdown-header noti-title">
                            <h6 class="text-overflow m-0">Welcome!</h6>
                        </div>
                        <a href="{% url 'user:profile' %}" class="dropdown-item">
                            <i class="ni ni-single-02"></i>
                            <span>My profile</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{% url 'user:logout' %}" class="dropdown-item">
                            <i class="ni ni-user-run"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </li>
            </ul>
            <!-- Collapse -->
            <div class="collapse navbar-collapse" id="sidenav-collapse-main">
                <!-- Collapse header -->
                <div class="navbar-collapse-header d-md-none">
                    <div class="row">
                        <div class="col-6 collapse-brand">
                            <a class="navbar-brand pt-0" style="font-size: 1.25rem" href="{% url 'user:index' %}">
                                <img src="{% static 'dashboard/assets/img/brand/favicon.png' %}">
                                <span class="btn-inner--text text-blue">Coding Container</span>
                            </a>
                        </div>
                        <div class="col-6 collapse-close">
                            <button type="button" class="navbar-toggler" data-toggle="collapse"
                                    data-target="#sidenav-collapse-main" aria-controls="sidenav-main"
                                    aria-expanded="false" aria-label="Toggle sidenav">
                                <span></span>
                                <span></span>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Navigation -->
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'user:dashboard' %}">
                            <i class="ni ni-tv-2 text-primary"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'user:containers' %}">
                            <i class="ni ni-bullet-list-67 text-red"></i> Containers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href={% url 'user:files' %}>
                            <i class="ni ni-ruler-pencil text-blue"></i> Files
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href={% url 'user:profile' %}>
                            <i class="ni ni-single-02 text-yellow"></i> User profile
                        </a>
                    </li>
                </ul>
                <!-- Divider -->
                <hr class="my-3">
            </div>
        </div>
    </nav>
    <!-- Main content -->
    <div class="main-content">
        <!-- Top navbar -->
        <nav class="navbar navbar-top navbar-expand-md navbar-dark" id="navbar-main">
            <div class="container-fluid">
                <!-- Brand -->
                <a class="h4 mb-0 text-white text-uppercase d-none d-lg-inline-block" href="{% url 'user:containers' %}"></a>
                <!-- User -->
                <ul class="navbar-nav align-items-center d-none d-md-flex">
                    <li class="nav-item dropdown">
                        <a class="nav-link pr-0" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                           aria-expanded="false">
                            <div class="media align-items-center">
                                <span class="ni ni-single-02 text-yellow"></span>
                                <div class="media-body ml-2 d-none d-lg-block">
                                    <span class="mb-0 text-sm  font-weight-bold">{{ request.session.enrollment_id }}</span>
                                </div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right">
                            <div class=" dropdown-header noti-title">
                                <h6 class="text-overflow m-0">Welcome!</h6>
                            </div>
                            <a href={% url 'user:profile' %} class="dropdown-item">
                                <i class="ni ni-single-02"></i>
                                <span>My profile</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="{% url 'user:logout' %}" class="dropdown-item">
                                <i class="ni ni-user-run"></i>
                                <span>Logout</span>
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- Header -->
        <div class="header bg-gradient-primary pb-8 pt-5 pt-md-6">
            <div class="container-fluid">
                <button type="button" id="save" class="btn btn-secondary">
                    <span class="btn-inner--icon"><i id="save_icon" class="fa fa-save"></i></span>
                    <span class="btn-inner--text">Save</span>
                </button>
                <button type="button" id="download" class="btn btn-secondary">
                    <span class="btn-inner--icon"><i id="download_icon" class="fa fa-download"></i></span>
                    <span class="btn-inner--text">Download</span>
                </button>
                <button class="btn btn-secondary" id="refresh">
                    <span class="btn-inner--icon"><i class="fa fa-redo-alt"></i></span>
                    <span class="btn-inner--text">Refresh</span>
                </button>
                <span id="tree" class="text-white text-right"></span>
                <div class="col-md-3 px-2" style="margin-bottom: -2rem; margin-left: -.5rem">
                    <div class="form-group">
                        <label></label>
                        <select id="modes" class="form-control text-darker"></select>
                    </div>
                </div>
            </div>
        </div>
        <!-- Page content -->
        <div class="container-fluid mt--7">
            <textarea id="editor" name="editor"></textarea>
        </div>
    </div>


<script>
    var modes = ['apl', 'asciiarmor', 'asn.1', 'asterisk', 'brainfuck', 'clike', 'clojure', 'cmake', 'cobol', 'coffeescript', 'commonlisp', 'crystal', 'css', 'cypher', 'd', 'dart', 'diff', 'django', 'dockerfile', 'dtd', 'dylan', 'ebnf', 'ecl', 'eiffel', 'elm', 'erlang', 'factor', 'fcl', 'forth', 'fortran', 'gas', 'gfm', 'gherkin', 'go', 'groovy', 'haml', 'handlebars', 'haskell', 'haskell-literate', 'haxe', 'htmlembedded', 'htmlmixed', 'http', 'idl', 'javascript', 'jinja2', 'jsx', 'julia', 'livescript', 'lua', 'markdown', 'mathematica', 'mbox', 'mirc', 'mllike', 'modelica', 'mscgen', 'mumps', 'nginx', 'nsis', 'ntriples', 'octave', 'oz', 'pascal', 'pegjs', 'perl', 'php', 'pig', 'powershell', 'properties', 'protobuf', 'pug', 'puppet', 'python', 'q', 'r', 'rpm', 'rst', 'ruby', 'rust', 'sas', 'sass', 'scheme', 'shell', 'sieve', 'slim', 'smalltalk', 'smarty', 'solr', 'soy', 'sparql', 'spreadsheet', 'sql', 'stex', 'stylus', 'swift', 'tcl', 'textile', 'tiddlywiki', 'tiki', 'toml', 'tornado', 'troff', 'ttcn', 'ttcn-cfg', 'turtle', 'twig', 'vb', 'vbscript', 'velocity', 'verilog', 'vhdl', 'vue', 'webidl', 'xml', 'xquery', 'yacas', 'yaml', 'yaml-frontmatter', 'z80'];
    var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        lineNumbers: true,
        theme: 'dracula',
        mode: "xml",
        autofocus: true,
        autoCloseTags: true
    });

    $(document).ready(function () {
        initialize();
    });

    function initialize() {
        var tree = document.getElementById('tree');
        tree.innerHTML = '{{ path }}';

        var select_mode = document.getElementById('modes');
        for (var mode in modes) {
            select_mode.innerHTML += '<option id="' + modes[mode] + '" value="' + modes[mode] + '">' + modes[mode] + '</option>'
        }

        $('.CodeMirror').height($(window).height()/1.5);
        $.ajax({
            type: 'POST',
            url: '{% url 'user:edit_file' %}',
            data: {
                'container_id': "{{ container_id }}",
                'path': "{{ path }}"
            },
            success: function (data) {
                if (data['data'] != 'err') {
                    editor.setValue(data['data']);
                }else {
                    alert('Cannot Open File');
                }
            },
            error: function (data) {
                console.log(data);
                alert("Something went wrong!");
            }
        });
    }

    $('#modes').change(function () {
        var mode = $(this).val();
        var dir = "{% static 'codemirror/mode' %}" + "/" + mode + "/";
        var file = this.value + ".js";
        var scr = document.createElement("script");
        scr.src = dir + file;
        document.body.appendChild(scr);
        scr.onload = function(){
            editor.setOption("mode", mode);
        };
    });

    $('#save').click(function () {
        $.ajax({
            type: 'POST',
            url: '{% url 'user:edit_file' %}',
            data: {
                'container_id': "{{ container_id }}",
                'path': "{{ path }}",
                'data': editor.getValue()
            },
            success: function (data) {
                if (data['data'] != 'err') {
                    console.log("Success");
                    document.getElementById('save').style.opacity = '0.7';
                    document.getElementById('save_icon').className = "ni ni-check-bold";
                }else {
                    alert('Cannot Save File');
                }
            },
            error: function (data) {
                console.log(data);
                alert("Something went wrong!");
            }
        });
        window.setTimeout(function () {
            document.getElementById('save_icon').className = "fa fa-save";
            document.getElementById('save').style.opacity = '1';
        }, 2000);
    });

    CodeMirror.commands.save = function() {
        $('#save').click();
    };

    $('#download').click(function () {
        var textToWrite = editor.getValue();
        var textFileAsBlob = new Blob([textToWrite], {
            type: "text/plain;charset=utf-8"
        });
        var fileNameToSaveAs = "{{ path }}".split("/").slice(-1);

        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        if (window.webkitURL != null) {
            // Chrome allows the link to be clicked
            // without actually adding it to the DOM.
            downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
        } else {
            // Firefox requires the link to be added to the DOM
            // before it can be clicked.
            downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
        }

        downloadLink.click();
    });

    $('#refresh').click(function () {
        editor.setValue("");
        document.getElementById('refresh').style.opacity = '0.7';
        window.setTimeout(function () {
            document.getElementById('refresh').style.opacity = '1';
        }, 2000);
        initialize();
    });

    editor.on('inputRead', function onChange(editor, input) {
        if (input.text[0] === ';' || input.text[0] === ' ') { return; }
        CodeMirror.commands.autocomplete(editor, null, { completeSingle: false })
    });

</script>

{% endblock %}
